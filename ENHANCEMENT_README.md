# EdgeOne地理位置增强功能说明

## 功能概述
本项目已成功集成多数据源地理位置信息获取功能，能够智能获取更准确的城市和ISP信息。

## 技术方案
- **主数据源**: EdgeOne内置地理位置数据
- **增强数据源**: 自建lbs-api服务 (https://lbs.test.cn/)
- **缓存机制**: EdgeOne KV存储，TTL 1天
- **降级策略**: API失败时使用原始EO数据

## 工作流程
1. 检查EO内置数据完整性（cityName和cisp字段）
2. 如果数据完整 → 直接返回
3. 如果数据不完整 → 检查KV缓存
4. 缓存命中 → 融合数据返回
5. 缓存未命中 → 调用lbs-api
6. API成功 → 缓存结果并返回融合数据
7. API失败 → 降级返回EO原始数据

## KV存储配置
- **命名空间**: `ip`
- **变量名称**: `IP_KV`
- **键格式**: `geo_cache_{ip地址}`
- **值格式**: `{"city": "济南", "isp": "中国联通", "timestamp": 1692686400}`
- **缓存时长**: 1天（通过timestamp判断）

## API测试结果
```json
{
   "ip":"123.129.224.247",
   "continent":"亚洲",
   "country":"中国",
   "province":"山东",
   "city":"济南",
   "district":"",
   "organization":"中国联通/网通",
   "iso_code":"CN",
   "location":{"longitude":117.000923,"latitude":36.675807,"accuracy_radius":1000}
}
```

## 性能优化
- 3秒API超时限制
- 智能缓存避免重复请求
- 优雅降级保证服务可用性
- 最小化代码侵入

## 部署说明
1. **创建KV存储**：
   - 在EdgeOne控制台创建KV存储命名空间：`ip`
   - 设置变量名称：`IP_KV`
   - 绑定到边缘函数

2. **部署代码**：
   - 部署修改后的`functions/geo/index.ts`文件
   - 确保函数使用 `onRequestGet` 而不是 `onRequest`
   - 确保KV变量 `IP_KV` 在全局作用域中可用

3. **调试验证**：
   - 访问你的边缘函数URL
   - 查看返回数据中的 `_debug` 字段，了解执行流程
   - 检查是否调用了lbs-api（通过后端日志确认）
   - 检查KV存储中是否有缓存数据

4. **验证服务**：
   - 确认lbs-api服务 https://lbs.test.cn/ 可用
   - 测试边缘函数返回增强的地理位置信息

## 调试信息说明
当前版本包含 `_debug` 字段，显示：
- 原始数据检查结果
- 缓存读取情况
- API调用状态
- KV写入结果

部署后请查看 `_debug` 字段内容，确定问题所在。

## 监控建议
- 监控lbs-api响应时间和成功率
- 监控KV存储使用情况
- 设置API调用失败告警